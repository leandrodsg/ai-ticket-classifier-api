# Authentication & Security

The API uses HMAC-based request signing to verify CSV file integrity and prevent tampering. No API keys or tokens are required for endpoint access.

## Rate Limiting

All endpoints have rate limits to prevent abuse:

- CSV Generation: 60 requests/minute per IP
- Ticket Upload: 10 requests/minute per IP
- Job Query: 120 requests/minute per IP
- System Info: 120 requests/minute per IP

Rate limit headers are included in responses:

```
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 59
```

When exceeded, the API returns HTTP 429 with a `Retry-After` header.

## HMAC Signature

CSV files generated by the API include metadata headers that must be validated on upload.

### Metadata Structure

The CSV includes these headers:

```csv
# X-Session-Id: 9d3e4f5a-1234-5678-9abc-def012345678
# X-Nonce: abcdef1234567890abcdef1234567890
# X-Timestamp: 2025-12-29T10:30:45+00:00
# X-Expires-At: 2025-12-29T11:30:45+00:00
# X-Row-Count: 5
# X-Signature: a1b2c3d4e5f6...
# X-Signature-Algorithm: sha256

Issue Key,Summary,Description,Reporter,Priority,Status,Created,Labels,Assignee
...
```

### Signature Generation

The signature is computed over this string:

```
session_id|nonce|timestamp|expires_at|row_count
```

Using HMAC-SHA256 with the application key:

```php
$data = implode('|', [
    $sessionId,
    $nonce,
    $timestamp,
    $expiresAt,
    $rowCount
]);

$signature = hash_hmac('sha256', $data, $appKey);
```

### Upload Validation

When uploading, the API verifies:

1. **Signature Match**: Recomputes HMAC and compares with X-Signature
2. **Nonce Uniqueness**: Checks nonce hasn't been used before
3. **Timestamp Validity**: Ensures timestamp is within 5-minute window
4. **Not Expired**: Checks current time < X-Expires-At
5. **Row Count**: Verifies actual rows match declared count

Headers must be included in the upload request:

```
POST /api/tickets/upload
X-Signature: a1b2c3d4e5f6...
X-Nonce: abcdef1234567890abcdef1234567890
X-Timestamp: 2025-12-29T10:30:45+00:00
Content-Type: application/json

{
  "csv_content": "base64-encoded-content"
}
```

### Nonce Mechanism

A nonce is a single-use token that prevents replay attacks. Each nonce:

- Is 32 characters long (hex)
- Can only be used once
- Expires after 1 hour
- Is stored in the database upon first use

If a nonce is reused, the request is rejected with HTTP 400.

## Error Responses

### Invalid Signature

```json
{
  "success": false,
  "error": "invalid_signature",
  "message": "HMAC signature validation failed"
}
```

### Expired Timestamp

```json
{
  "success": false,
  "error": "expired_timestamp",
  "message": "Request timestamp has expired"
}
```

### Nonce Reused

```json
{
  "success": false,
  "error": "nonce_reused",
  "message": "Nonce has already been used"
}
```

## Security Best Practices

### For API Consumers

1. Always use generated CSV files from `/api/csv/generate`
2. Upload CSV immediately after generation (1-hour expiry)
3. Store session IDs securely for job status queries
4. Never modify CSV content or metadata
5. Implement exponential backoff for job polling

### CSV File Handling

Generated CSV files are valid for 1 hour. After expiry, generate a new file. Do not:

- Manually edit CSV content
- Modify metadata headers
- Reuse expired files
- Share CSV files between environments

### Rate Limit Handling

Implement retry logic with exponential backoff:

```javascript
async function uploadWithRetry(csvContent, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    const response = await fetch('/api/tickets/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ csv_content: csvContent })
    });
    
    if (response.status === 429) {
      const retryAfter = response.headers.get('Retry-After');
      await sleep(retryAfter * 1000);
      continue;
    }
    
    return response;
  }
  throw new Error('Max retries exceeded');
}
```

## Testing Authentication

Generate a test CSV:

```bash
curl -X POST http://localhost:8000/api/csv/generate \
  -H "Content-Type: application/json" \
  -d '{"ticket_count": 3}'
```

Extract the base64 content and headers, then upload:

```bash
curl -X POST http://localhost:8000/api/tickets/upload \
  -H "Content-Type: application/json" \
  -H "X-Signature: extracted-signature" \
  -H "X-Nonce: extracted-nonce" \
  -H "X-Timestamp: extracted-timestamp" \
  -d '{"csv_content": "extracted-base64-content"}'
```

The upload should succeed if all validations pass.
